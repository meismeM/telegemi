from time import sleep

import google.generativeai as genai

from .auth import is_admin
from .config import ALLOWED_USERS,IS_DEBUG_MODE,GOOGLE_API_KEY
from .printLog import send_log
from .telegram import send_message

admin_auch_info = "You are not the administrator or your administrator ID is set incorrectly!!!"
debug_mode_info = "Debug mode is not enabled!"

def help():
    help_text = "Welcome to Gemini 1.5 Pro AI! Interact through text or images and experience insightful answers. Unlock the power of AI-driven communication â€“ every message is a chance for a smarter exchange. Send text or image!\n Experience the power of AI-driven communication through insightful answers, text, or images. \nğŸ‘¾ Features \n Answer any question, even challenging or strange ones. \n â© Generate creative text formats like poems, scripts, code, emails, and more. \n â© Translate languages effortlessly. \n â© Simplify complex concepts with clear explanations. \n â©  Perform math and calculations. \n â© Assist with research and creative content generation. \n â© Provide fun with word games, quizzes, and much more!\n â© Send a text or image and unlock smarter exchanges. Donâ€™t forget to join the channels below for more: And most importantly join the channels:  \n [Channel 1](https://t.me/+gOUK4JnBcCtkYWQ8) \n [Channel 2](https://t.me/telegemin). \n á‹ˆá‹° áŒ€áˆšáŠ’ 1.5 á•áˆ® áŠ áˆ­á‰´áŠáˆ»áˆ áŠ¢áŠ•á‰°áˆˆáŒ€áŠ•áˆµ áŠ¥áŠ•áŠ³áŠ• á‹°áˆ…áŠ“ áˆ˜áŒ¡! á‹µáŠ•á‰… 3 áŠ¨áá‰°áŠ› á‰°áŒ á‰ƒáˆšá‹á‰½ á‹«áˆ‰á‰µ áŒáŒáˆ AI á£ áŠ¥áŠ” áŠ¥á‹šáˆ… áˆµááˆ­ á‰áŒ¥áˆ­ á‰ áˆŒáˆ‹á‰¸á‹ áˆ˜áŠ•áŒˆá‹¶á‰½ áˆáˆ¨á‹³á‰½áˆ á‹¨áˆá‰½áˆ á‹¨áŠ áˆ­á‰´áŠáˆ»áˆ áŠ¢áŠ•á‰°áˆˆáŒ€áŠ•áˆµ á‰»á‰µ á‰¦á‰µ áŠáŠá¢ á‰ áŠ áˆµá‰°á‹‹á‹­ áˆ˜áˆáˆ¶á‰½á£ á‰ áŒ½áˆ‘á á‹ˆá‹­áˆ á‰ áˆáˆµáˆá‰½ á‹¨áŠ áˆ­á‰´áŠáˆ»áˆ áŠ¢áŠ•á‰°áˆˆáŒ€áŠ•áˆµ á‹¨á‰°áŒáˆ‹á‰ á‰° á‹¨áŒáŠ•áŠ™áŠá‰µ á‹­áˆˆáˆ›áˆ˜á‹±á¢ \n \n â© áˆ›áŠ•áŠ›á‹áŠ•áˆ áŒ¥á‹«á‰„á£ áˆá‰³áŠ á‹ˆá‹­áˆ áŠ¥áŠ•áŒá‹³ á‹¨áˆ†áŠ‘á‰µáŠ•áˆ áŠ¥áŠ•áŠ³ áˆ˜áˆáˆµ á‹«áŒáŠ™á¢ \n â© áŠ¥áŠ•á‹° áŒáŒ¥áˆá£ áˆµáŠ­áˆªá•á‰µá£ áŠ®á‹µá£ áŠ¢áˆœá‹­áˆá‰½ áŠ¥áŠ“ áˆŒáˆá‰½áˆ á‹«áˆ‰ á‹¨áˆáŒ áˆ« áŒ½áˆ‘áá‰½áŠ• á‹­ááŒ áˆ©á¢ \n â© á‰‹áŠ•á‰‹á‹á‰½áŠ• á‰ á‰€áˆ‹áˆ‰ áˆ˜á‰°áˆ­áŒáˆá¢ \n â© á‹áˆµá‰¥áˆµá‰¥ áŒ½áŠ•áˆ°-áˆáˆ³á‰¦á‰½áŠ• á‰ áŒáˆáŒ½ áˆ›á‰¥áˆ«áˆ«á‰µá¢ \n â© á‹¨áˆ‚áˆ³á‰¥ áˆµáˆŒá‰¶á‰½áŠ• áˆ˜áˆµáˆ«á‰µá¢ \n â© á‰ áˆáˆ­áˆáˆ­ áŠ¥áŠ“ á‰ áˆáŒ áˆ« á‹­á‹˜á‰µ á‹«áˆ‹á‰¸á‹ á…áˆáá‰½á¢ \n â© á‰ á‰ƒáˆ‹á‰µ áŒ¨á‹‹á‰³á‹á‰½á£ áŒ¥á‹«á‰„á‹á‰½ áŠ¥áŠ“ á‰ á‰¥á‹™ á‰°áŒ¨áˆ›áˆª áŠáŒˆáˆ®á‰½ á‹­á‹áŠ“áŠ‘!\n â© áŒ½áˆ‘á á‹ˆá‹­áˆ áˆáˆµáˆ á‹­áˆ‹áŠ© áŠ¥áŠ“ áˆ˜áˆáˆµ á‹«áŒáŠ™á¢ áˆˆá‰°áŒ¨áˆ›áˆª áˆ˜áˆ¨áŒƒ áŠ¨á‰³á‰½ á‰£áˆ‰á‰µ á‰»áŠ“áˆá‰½ áˆ˜á‰€áˆ‹á‰€áˆá‹áŠ• áŠ á‹­áˆ­áˆ±á¢"
    command_list = "/new - Start a new chat" #\n/get_my_info - Get personal information\n/get_allowed_users - Get the list of users allowed to use robots (available only to admin)\n/list_models - List available models (available only to admin)\n/get_api_key - Get API key (available only to admin)"
    result = f"{help_text}\n\n{command_list}"
    return result

def list_models():
    for m in genai.list_models():
        send_log(str(m))
        if 'generateContent' in m.supported_generation_methods:
            send_log(str(m.name))
    return ""

def get_allowed_users():
    send_log(f"```json\n{ALLOWED_USERS}```")
    return ""


def get_API_key():
    send_log(f"```json\n{GOOGLE_API_KEY}```")
    return ""

def speed_test(id):
    send_message(id, "å¼€å§‹æµ‹é€Ÿ")
    sleep(5)
    return "æµ‹è¯•å®Œæˆï¼Œæ‚¨çš„5Gé€Ÿåº¦ä¸ºï¼š\n**114514B/s**"

def send_message_test(id, command):
    if not is_admin(id):
        return admin_auch_info
    a = command.find(" ")
    b = command.find(" ", a + 1)
    if a == -1 or b == -1:
        return "Command format error"
    to_id = command[a+1:b]
    text = command[b+1:]
    try:
        send_message(to_id, text)
    except Exception as e:
        send_log(f"err:\n{e}")
        return
    send_log("success")
    return ""

def excute_command(from_id, command):
    if command == "start" or command == "help":
        return help()

    elif command == "get_my_info":
        result = f"your telegram id is: `{from_id}`"
        return result

    elif command == "5g_test":
        return speed_test(from_id)

    elif command.startswith("send_message"):
        return send_message_test(from_id, command)

    elif command in ["get_allowed_users", "get_api_key", "list_models"]:
        if not is_admin(from_id):
            return admin_auch_info
        if IS_DEBUG_MODE == "0":
            return debug_mode_info

        if command == "get_allowed_users":
            return get_allowed_users()
        elif command == "get_api_key":
            return get_API_key()
        elif command == "list_models":
            return list_models()

    else:
        result = "Invalid command, use /help for help"
        return result
